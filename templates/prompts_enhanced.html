{% extends "base.html" %}

{% block page_title %}Prompt Management{% endblock %}

{% block content %}
<div class="container-fluid">
	<!-- Prompt Statistics -->
	<div class="row mb-4">
		<div class="col-md-3">
			<div class="card text-center">
				<div class="card-body">
					<h5 class="card-title">Total Prompts</h5>
					<h2 class="text-primary" id="totalPromptsCount">0</h2>
					<small class="text-muted">All system prompts</small>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="card text-center">
				<div class="card-body">
					<h5 class="card-title">Active Prompts</h5>
					<h2 class="text-success" id="activePromptsCount">0</h2>
					<small class="text-muted">Currently enabled</small>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="card text-center">
				<div class="card-body">
					<h5 class="card-title">Total Uses</h5>
					<h2 class="text-info" id="totalUsesCount">0</h2>
					<small class="text-muted">Prompt invocations</small>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="card text-center">
				<div class="card-body">
					<h5 class="card-title">Avg Rating</h5>
					<h2 class="text-warning" id="avgRatingCount">0</h2>
					<small class="text-muted">User satisfaction</small>
				</div>
			</div>
		</div>
	</div>

	<!-- Search and Actions -->
	<div class="row mb-4">
		<div class="col-md-6">
			<div class="input-group">
				<input type="text" class="form-control" id="searchPrompts" placeholder="Search prompts...">
				<button class="btn btn-outline-secondary" type="button">
					<i class="fas fa-search"></i>
				</button>
			</div>
		</div>
		<div class="col-md-6 text-end">
			<button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addPromptModal">
				<i class="fas fa-plus"></i> Create Prompt
			</button>
			<button class="btn btn-outline-secondary" onclick="exportPrompts()">
				<i class="fas fa-download"></i> Export
			</button>
		</div>
	</div>

	<!-- Prompts Table -->
	<div class="card">
		<div class="card-header">
			<div class="d-flex justify-content-between align-items-center">
				<h5>Prompt Library</h5>
				<span class="badge bg-secondary" id="promptCount">0 prompts</span>
			</div>
		</div>
		<div class="card-body">
			<div class="table-responsive">
				<table class="table">
					<thead>
						<tr>
							<th>Name</th>
							<th>Category</th>
							<th>Status</th>
							<th>Uses</th>
							<th>Rating</th>
							<th>Version</th>
							<th>Created</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody id="promptList">
						<tr>
							<td colspan="8" class="text-center text-muted">Loading prompts...</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<!-- Prompt Usage Chart -->
	<div class="row mt-4">
		<div class="col-md-6">
			<div class="card">
				<div class="card-header">
					<h5>Top Prompts by Usage</h5>
				</div>
				<div class="card-body">
					<div id="topPrompts">
						<div class="text-muted">Loading...</div>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-6">
			<div class="card">
				<div class="card-header">
					<h5>Prompt Performance</h5>
				</div>
				<div class="card-body">
					<div class="chart-container">
						<canvas id="performanceChart"></canvas>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Add Prompt Modal -->
<div class="modal fade" id="addPromptModal" tabindex="-1">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Create New Prompt</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<form id="addPromptForm">
				<div class="modal-body">
					<div class="mb-3">
						<label for="promptName" class="form-label">Prompt Name</label>
						<input type="text" class="form-control" id="promptName" name="name" required>
					</div>
					<div class="mb-3">
						<label for="promptCategory" class="form-label">Category</label>
						<select class="form-select" id="promptCategory" name="category" required>
							<option value="general">General</option>
							<option value="customer_service">Customer Service</option>
							<option value="technical">Technical Support</option>
							<option value="sales">Sales</option>
							<option value="other">Other</option>
						</select>
					</div>
					<div class="mb-3">
						<label for="promptContent" class="form-label">Prompt Content</label>
						<textarea class="form-control" id="promptContent" name="content" rows="6" required></textarea>
					</div>
					<div class="mb-3">
						<label for="promptStatus" class="form-label">Status</label>
						<select class="form-select" id="promptStatus" name="status" required>
							<option value="active">Active</option>
							<option value="inactive">Inactive</option>
							<option value="draft">Draft</option>
						</select>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-primary">Create Prompt</button>
				</div>
			</form>
		</div>
	</div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let allPrompts = [];

async function loadPrompts() {
	try {
		const res = await fetch('/api/prompts');
		if (!res.ok) throw new Error('Failed to load prompts');
		allPrompts = await res.json();
		renderPrompts(allPrompts);
		updatePromptStats();
		loadCharts();
	} catch (error) {
		console.error('Error loading prompts:', error);
		document.getElementById('promptList').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading prompts</td></tr>';
	}
}

function renderPrompts(prompts) {
	const tbody = document.getElementById('promptList');
	if (prompts.length === 0) {
		tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No prompts found</td></tr>';
		return;
	}
	
	tbody.innerHTML = prompts.map(p => `
		<tr>
			<td><strong>${p.name}</strong></td>
			<td><span class="badge bg-info">${p.category || 'general'}</span></td>
			<td><span class="badge bg-${p.status === 'active' ? 'success' : 'secondary'}">${p.status}</span></td>
			<td>${p.usage_count || 0}</td>
			<td>
				<div class="d-flex align-items-center">
					<i class="fas fa-star text-warning me-1"></i>
					<span>${(p.rating || 0).toFixed(1)}</span>
				</div>
			</td>
			<td>v${p.version || 1}</td>
			<td><small>${new Date(p.created_at).toLocaleDateString()}</small></td>
			<td>
				<button class="btn btn-sm btn-outline-primary me-1" onclick="editPrompt(${p.id})">
					<i class="fas fa-edit"></i>
				</button>
				<button class="btn btn-sm btn-outline-danger" onclick="deletePrompt(${p.id})">
					<i class="fas fa-trash"></i>
				</button>
			</td>
		</tr>
	`).join('');
	
	document.getElementById('promptCount').textContent = `${prompts.length} prompts`;
}

function updatePromptStats() {
	const total = allPrompts.length;
	const active = allPrompts.filter(p => p.status === 'active').length;
	const totalUses = allPrompts.reduce((sum, p) => sum + (p.usage_count || 0), 0);
	const avgRating = allPrompts.length > 0 ? (allPrompts.reduce((sum, p) => sum + (p.rating || 0), 0) / allPrompts.length).toFixed(1) : 0;
	
	document.getElementById('totalPromptsCount').textContent = total;
	document.getElementById('activePromptsCount').textContent = active;
	document.getElementById('totalUsesCount').textContent = totalUses;
	document.getElementById('avgRatingCount').textContent = avgRating;
}

function loadCharts() {
	// Top Prompts
	const topPrompts = allPrompts.sort((a, b) => (b.usage_count || 0) - (a.usage_count || 0)).slice(0, 5);
	const html = topPrompts.map(p => `
		<div class="d-flex justify-content-between align-items-center mb-3 pb-3" style="border-bottom: 1px solid #eee;">
			<div>
				<h6 class="mb-1">${p.name}</h6>
				<small class="text-muted">${p.category || 'general'}</small>
			</div>
			<div class="text-end">
				<span class="badge bg-primary">${p.usage_count || 0} uses</span>
			</div>
		</div>
	`).join('');
	document.getElementById('topPrompts').innerHTML = html || '<div class="text-muted">No prompts found</div>';
	
	// Performance Chart
	new Chart(document.getElementById('performanceChart').getContext('2d'), {
		type: 'bar',
		data: {
			labels: allPrompts.slice(0, 5).map(p => p.name),
			datasets: [{
				label: 'Usage Count',
				data: allPrompts.slice(0, 5).map(p => p.usage_count || 0),
				backgroundColor: '#4a6cf7'
			}]
		},
		options: {
			responsive: true,
			maintainAspectRatio: false,
			scales: {
				y: {
					beginAtZero: true
				}
			}
		}
	});
}

async function editPrompt(id) {
	const promptObj = allPrompts.find(p => p.id === id);
	if (!promptObj) return alert('Prompt not found');

	const newName = window.prompt('Enter prompt name:', promptObj.name);
	if (newName === null) return;

	try {
		const res = await fetch(`/api/prompts/${id}`, {
			method: 'PUT',
			headers: {'Content-Type': 'application/json'},
			body: JSON.stringify({
				name: newName,
				content: promptObj.content,
				category: promptObj.category,
				status: promptObj.status
			})
		});
		if (res.ok) {
			loadPrompts();
			showNotification('Prompt updated successfully', 'success');
		} else {
			showNotification('Failed to update prompt', 'error');
		}
	} catch (error) {
		console.error('Error updating prompt:', error);
		showNotification('Error updating prompt', 'error');
	}
}

async function deletePrompt(id) {
	if (!confirm('Are you sure you want to delete this prompt?')) return;
	
	try {
		const res = await fetch(`/api/prompts/${id}`, {method: 'DELETE'});
		if (res.ok) {
			loadPrompts();
			showNotification('Prompt deleted successfully', 'success');
		} else {
			showNotification('Failed to delete prompt', 'error');
		}
	} catch (error) {
		console.error('Error deleting prompt:', error);
		showNotification('Error deleting prompt', 'error');
	}
}

function exportPrompts() {
	const csv = 'Name,Category,Status,Uses,Rating\n' + allPrompts.map(p => 
		`${p.name},${p.category || 'general'},${p.status},${p.usage_count || 0},${(p.rating || 0).toFixed(1)}`
	).join('\n');
	
	const blob = new Blob([csv], {type: 'text/csv'});
	const url = window.URL.createObjectURL(blob);
	const a = document.createElement('a');
	a.href = url;
	a.download = 'prompts.csv';
	a.click();
	showNotification('Prompts exported successfully', 'success');
}

function showNotification(message, type) {
	const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
	const alert = document.createElement('div');
	alert.className = `alert ${alertClass} alert-dismissible fade show`;
	alert.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
	document.body.insertBefore(alert, document.body.firstChild);
	setTimeout(() => alert.remove(), 3000);
}

document.addEventListener('DOMContentLoaded', () => {
	loadPrompts();
	
	// Add prompt form
	const addForm = document.getElementById('addPromptForm');
	addForm.addEventListener('submit', async (e) => {
		e.preventDefault();
		const body = Object.fromEntries(new FormData(addForm).entries());
		try {
			const res = await fetch('/api/prompts', {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify(body)
			});
			if (res.ok) {
				addForm.reset();
				bootstrap.Modal.getInstance(document.getElementById('addPromptModal')).hide();
				loadPrompts();
				showNotification('Prompt created successfully', 'success');
			} else {
				showNotification('Failed to create prompt', 'error');
			}
		} catch (error) {
			console.error('Error creating prompt:', error);
			showNotification('Error creating prompt', 'error');
		}
	});
	
	// Search functionality
	document.getElementById('searchPrompts').addEventListener('input', (e) => {
		const search = e.target.value.toLowerCase();
		const filtered = allPrompts.filter(p => 
			p.name.toLowerCase().includes(search) || 
			(p.category || '').toLowerCase().includes(search)
		);
		renderPrompts(filtered);
	});
});
</script>
{% endblock %}

