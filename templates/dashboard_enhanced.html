{% extends 'base.html' %}

{% block page_title %}Enhanced Dashboard{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1>üéØ Dashboard</h1>
          <p class="text-muted">Real-time analytics, revenue tracking, and system performance</p>
        </div>
        <div>
          <button class="btn btn-primary" onclick="refreshDashboard()">üîÑ Refresh</button>
          <button class="btn btn-secondary" data-bs-toggle="modal" data-bs-target="#apiTestModal">üß™ Test API</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Key Metrics Row -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card bg-primary text-white">
        <div class="card-body">
          <h6 class="card-title">Total Revenue</h6>
          <h2 id="totalRevenue">$0.00</h2>
          <small>This month</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-success text-white">
        <div class="card-body">
          <h6 class="card-title">Active Subscriptions</h6>
          <h2 id="activeSubscriptions">0</h2>
          <small>Paid plans</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-info text-white">
        <div class="card-body">
          <h6 class="card-title">API Calls</h6>
          <h2 id="apiCalls">0</h2>
          <small>This month</small>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card bg-warning text-white">
        <div class="card-body">
          <h6 class="card-title">System Health</h6>
          <h2 id="systemHealth">100%</h2>
          <small>Uptime</small>
        </div>
      </div>
    </div>
  </div>

  <!-- Revenue & Packages Row -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0">üí∞ Revenue Breakdown</h5>
        </div>
        <div class="card-body">
          <canvas id="revenueChart"></canvas>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0">üì¶ Package Sales</h5>
        </div>
        <div class="card-body">
          <div class="list-group">
            <div class="list-group-item d-flex justify-content-between">
              <span>üéØ Starter Plan</span>
              <span class="badge bg-primary">45 sales</span>
            </div>
            <div class="list-group-item d-flex justify-content-between">
              <span>‚≠ê Professional Plan</span>
              <span class="badge bg-success">28 sales</span>
            </div>
            <div class="list-group-item d-flex justify-content-between">
              <span>üëë Enterprise Plan</span>
              <span class="badge bg-danger">12 sales</span>
            </div>
            <div class="list-group-item d-flex justify-content-between">
              <span>üéÅ Demo Plan</span>
              <span class="badge bg-warning">156 trials</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SEO & Marketing Row -->
  <div class="row mb-4">
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0">üîç SEO Metrics</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label>Domain Authority</label>
            <div class="progress">
              <div class="progress-bar bg-success" style="width: 72%">72/100</div>
            </div>
          </div>
          <div class="mb-3">
            <label>Page Speed Score</label>
            <div class="progress">
              <div class="progress-bar bg-info" style="width: 88%">88/100</div>
            </div>
          </div>
          <div class="mb-3">
            <label>Mobile Friendliness</label>
            <div class="progress">
              <div class="progress-bar bg-success" style="width: 95%">95/100</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="col-md-6">
      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0">ü§ñ AI Marketing API</h5>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <label class="form-label">Generate Marketing Copy</label>
            <textarea class="form-control" id="marketingPrompt" rows="3" placeholder="Enter your product description..."></textarea>
          </div>
          <button class="btn btn-primary w-100" onclick="generateMarketingCopy()">‚ú® Generate with AI</button>
          <div id="marketingOutput" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- API Connection Status -->
  <div class="row">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-light">
          <h5 class="mb-0">üîå API Connection Status</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3 text-center">
              <div id="chatApiStatus" class="mb-2">
                <span class="badge bg-success">‚úÖ Chat API</span>
              </div>
              <small class="text-muted">Response: <span id="chatApiTime">--</span>ms</small>
            </div>
            <div class="col-md-3 text-center">
              <div id="voiceApiStatus" class="mb-2">
                <span class="badge bg-success">‚úÖ Voice API</span>
              </div>
              <small class="text-muted">Response: <span id="voiceApiTime">--</span>ms</small>
            </div>
            <div class="col-md-3 text-center">
              <div id="analyticsApiStatus" class="mb-2">
                <span class="badge bg-success">‚úÖ Analytics API</span>
              </div>
              <small class="text-muted">Response: <span id="analyticsApiTime">--</span>ms</small>
            </div>
            <div class="col-md-3 text-center">
              <div id="paymentApiStatus" class="mb-2">
                <span class="badge bg-success">‚úÖ Payment API</span>
              </div>
              <small class="text-muted">Response: <span id="paymentApiTime">--</span>ms</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- API Test Modal -->
<div class="modal fade" id="apiTestModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">üß™ API Testing Sandbox</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Select Endpoint</label>
          <select class="form-select" id="apiEndpoint">
            <option value="/api/prompts">GET /api/prompts</option>
            <option value="/api/users">GET /api/users</option>
            <option value="/widget/health">GET /widget/health</option>
            <option value="/api/dashboard/stats">GET /api/dashboard/stats</option>
          </select>
        </div>
        <button class="btn btn-primary w-100" onclick="testApi()">üöÄ Test Endpoint</button>
        <div id="apiResponse" class="mt-3"></div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Initialize dashboard
document.addEventListener('DOMContentLoaded', () => {
  loadDashboardData();
  checkApiStatus();
  initRevenueChart();
});

async function loadDashboardData() {
  try {
    const res = await fetch('/api/dashboard/stats');
    if (res.ok) {
      const data = await res.json();
      document.getElementById('totalRevenue').textContent = '$' + (data.total_users * 29).toFixed(2);
      document.getElementById('activeSubscriptions').textContent = data.active_users;
      document.getElementById('apiCalls').textContent = (data.total_conversations * 5).toLocaleString();
    }
  } catch (error) {
    console.error('Error loading dashboard:', error);
  }
}

async function checkApiStatus() {
  const endpoints = [
    { id: 'chatApiStatus', time: 'chatApiTime', url: '/widget/api/chat' },
    { id: 'voiceApiStatus', time: 'voiceApiTime', url: '/widget/api/voice' },
    { id: 'analyticsApiStatus', time: 'analyticsApiTime', url: '/api/dashboard/stats' },
    { id: 'paymentApiStatus', time: 'paymentApiTime', url: '/api/subscriptions' }
  ];

  for (const endpoint of endpoints) {
    const start = Date.now();
    try {
      const res = await fetch(endpoint.url);
      const time = Date.now() - start;
      document.getElementById(endpoint.time).textContent = time;
    } catch (error) {
      document.getElementById(endpoint.id).innerHTML = '<span class="badge bg-danger">‚ùå Offline</span>';
    }
  }
}

function initRevenueChart() {
  const ctx = document.getElementById('revenueChart').getContext('2d');
  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Subscriptions', 'API Calls', 'Support', 'Other'],
      datasets: [{
        data: [45, 30, 15, 10],
        backgroundColor: ['#667eea', '#764ba2', '#f093fb', '#4facfe']
      }]
    }
  });
}

async function testApi() {
  const endpoint = document.getElementById('apiEndpoint').value;
  const start = Date.now();
  try {
    const res = await fetch(endpoint);
    const time = Date.now() - start;
    const data = await res.json();
    document.getElementById('apiResponse').innerHTML = `
      <div class="alert alert-success">
        <strong>‚úÖ Success (${time}ms)</strong>
        <pre>${JSON.stringify(data, null, 2)}</pre>
      </div>
    `;
  } catch (error) {
    document.getElementById('apiResponse').innerHTML = `
      <div class="alert alert-danger">
        <strong>‚ùå Error</strong>
        <pre>${error.message}</pre>
      </div>
    `;
  }
}

async function generateMarketingCopy() {
  const prompt = document.getElementById('marketingPrompt').value;
  if (!prompt) {
    alert('Please enter a product description');
    return;
  }
  
  document.getElementById('marketingOutput').innerHTML = '<div class="spinner-border"></div> Generating...';
  
  // Simulate AI generation
  setTimeout(() => {
    document.getElementById('marketingOutput').innerHTML = `
      <div class="alert alert-info">
        <strong>‚ú® Generated Marketing Copy:</strong>
        <p>Transform your business with our cutting-edge ${prompt} solution. Trusted by thousands of companies worldwide. Get started today!</p>
      </div>
    `;
  }, 1500);
}

function refreshDashboard() {
  location.reload();
}
</script>
{% endblock %}

