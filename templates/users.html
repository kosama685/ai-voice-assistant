{% extends "base.html" %}

{% block page_title %}User Management{% endblock %}

{% block content %}
<div class="container-fluid">
	<!-- User Statistics -->
	<div class="row mb-4">
		<div class="col-md-3">
			<div class="card text-center">
				<div class="card-body">
					<h5 class="card-title">Total Users</h5>
					<h2 class="text-primary" id="totalUsersCount">0</h2>
					<small class="text-muted">All registered users</small>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="card text-center">
				<div class="card-body">
					<h5 class="card-title">Active Users</h5>
					<h2 class="text-success" id="activeUsersCount">0</h2>
					<small class="text-muted">Currently active</small>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="card text-center">
				<div class="card-body">
					<h5 class="card-title">Admins</h5>
					<h2 class="text-warning" id="adminCount">0</h2>
					<small class="text-muted">Administrator accounts</small>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="card text-center">
				<div class="card-body">
					<h5 class="card-title">Developers</h5>
					<h2 class="text-info" id="devCount">0</h2>
					<small class="text-muted">Developer accounts</small>
				</div>
			</div>
		</div>
	</div>

	<!-- Search and Actions -->
	<div class="row mb-4">
		<div class="col-md-6">
			<div class="input-group">
				<input type="text" class="form-control" id="searchUsers" placeholder="Search users by name or email...">
				<button class="btn btn-outline-secondary" type="button">
					<i class="fas fa-search"></i>
				</button>
			</div>
		</div>
		<div class="col-md-6 text-end">
			<button class="btn btn-primary me-2" data-bs-toggle="modal" data-bs-target="#addUserModal">
				<i class="fas fa-plus"></i> Add New User
			</button>
			<button class="btn btn-outline-secondary" onclick="exportUsers()">
				<i class="fas fa-download"></i> Export
			</button>
		</div>
	</div>

	<!-- Users Table -->
	<div class="card">
		<div class="card-header">
			<div class="d-flex justify-content-between align-items-center">
				<h5>User Directory</h5>
				<span class="badge bg-secondary" id="userCount">0 users</span>
			</div>
		</div>
		<div class="card-body">
			<div class="table-responsive">
				<table class="table">
					<thead>
						<tr>
							<th>User</th>
							<th>Email</th>
							<th>Role</th>
							<th>Status</th>
							<th>Usage</th>
							<th>Last Login</th>
							<th>Created</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody id="userList">
						<tr>
							<td colspan="8" class="text-center text-muted">Loading users...</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>

	<!-- User Distribution Chart -->
	<div class="row mt-4">
		<div class="col-md-6">
			<div class="card">
				<div class="card-header">
					<h5>Role Distribution</h5>
				</div>
				<div class="card-body">
					<div class="chart-container">
						<canvas id="roleChart"></canvas>
					</div>
				</div>
			</div>
		</div>
		<div class="col-md-6">
			<div class="card">
				<div class="card-header">
					<h5>User Status Distribution</h5>
				</div>
				<div class="card-body">
					<div class="chart-container">
						<canvas id="statusChart"></canvas>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Add New User</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<form id="addUserForm">
				<div class="modal-body">
					<div class="mb-3">
						<label for="newName" class="form-label">Full Name</label>
						<input type="text" class="form-control" id="newName" name="name" required>
					</div>
					<div class="mb-3">
						<label for="newEmail" class="form-label">Email</label>
						<input type="email" class="form-control" id="newEmail" name="email" required>
					</div>
					<div class="mb-3">
						<label for="newPassword" class="form-label">Password</label>
						<input type="password" class="form-control" id="newPassword" name="password" required>
					</div>
					<div class="mb-3">
						<label for="newRole" class="form-label">Role</label>
						<select class="form-select" id="newRole" name="role" required>
							<option value="tester">Tester</option>
							<option value="developer">Developer</option>
							<option value="admin">Admin</option>
						</select>
					</div>
					<div class="mb-3">
						<label for="newStatus" class="form-label">Status</label>
						<select class="form-select" id="newStatus" name="status" required>
							<option value="active">Active</option>
							<option value="inactive">Inactive</option>
						</select>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-primary">Add User</button>
				</div>
			</form>
		</div>
	</div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let allUsers = [];

async function loadUsers() {
	try {
		const res = await fetch('/api/users');
		if (!res.ok) throw new Error('Failed to load users');
		allUsers = await res.json();
		renderUsers(allUsers);
		updateUserStats();
		loadCharts();
	} catch (error) {
		console.error('Error loading users:', error);
		document.getElementById('userList').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Error loading users</td></tr>';
	}
}

function renderUsers(users) {
	const tbody = document.getElementById('userList');
	if (users.length === 0) {
		tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No users found</td></tr>';
		return;
	}

	tbody.innerHTML = users.map(u => `
		<tr>
			<td>
				<div class="d-flex align-items-center">
					<img src="https://picsum.photos/seed/${u.email}/40/40.jpg" alt="User" class="rounded-circle me-2" width="40" height="40">
					<strong>${u.name}</strong>
				</div>
			</td>
			<td>${u.email}</td>
			<td><span class="badge bg-${u.role === 'admin' ? 'danger' : u.role === 'developer' ? 'info' : 'secondary'}">${u.role}</span></td>
			<td><span class="badge bg-${u.status === 'active' ? 'success' : 'secondary'}">${u.status}</span></td>
			<td>
				<div class="progress" style="height: 20px;">
					<div class="progress-bar" style="width: ${(u.usage_current / u.usage_limit * 100)}%">${u.usage_current}/${u.usage_limit}</div>
				</div>
			</td>
			<td><small>${u.last_login ? new Date(u.last_login).toLocaleString() : 'Never'}</small></td>
			<td><small>${new Date(u.created_at).toLocaleDateString()}</small></td>
			<td>
				<button class="btn btn-sm btn-outline-primary me-1" onclick="editUser(${u.id})">
					<i class="fas fa-edit"></i>
				</button>
				<button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${u.id})">
					<i class="fas fa-trash"></i>
				</button>
			</td>
		</tr>
	`).join('');

	document.getElementById('userCount').textContent = `${users.length} users`;
}

function updateUserStats() {
	const total = allUsers.length;
	const active = allUsers.filter(u => u.status === 'active').length;
	const admins = allUsers.filter(u => u.role === 'admin').length;
	const devs = allUsers.filter(u => u.role === 'developer').length;

	document.getElementById('totalUsersCount').textContent = total;
	document.getElementById('activeUsersCount').textContent = active;
	document.getElementById('adminCount').textContent = admins;
	document.getElementById('devCount').textContent = devs;
}

function loadCharts() {
	// Role Distribution
	const roleCounts = {
		admin: allUsers.filter(u => u.role === 'admin').length,
		developer: allUsers.filter(u => u.role === 'developer').length,
		tester: allUsers.filter(u => u.role === 'tester').length
	};

	new Chart(document.getElementById('roleChart').getContext('2d'), {
		type: 'pie',
		data: {
			labels: ['Admin', 'Developer', 'Tester'],
			datasets: [{
				data: [roleCounts.admin, roleCounts.developer, roleCounts.tester],
				backgroundColor: ['#dc3545', '#0dcaf0', '#6c757d']
			}]
		},
		options: {
			responsive: true,
			maintainAspectRatio: false
		}
	});

	// Status Distribution
	const statusCounts = {
		active: allUsers.filter(u => u.status === 'active').length,
		inactive: allUsers.filter(u => u.status === 'inactive').length
	};

	new Chart(document.getElementById('statusChart').getContext('2d'), {
		type: 'doughnut',
		data: {
			labels: ['Active', 'Inactive'],
			datasets: [{
				data: [statusCounts.active, statusCounts.inactive],
				backgroundColor: ['#28a745', '#dc3545']
			}]
		},
		options: {
			responsive: true,
			maintainAspectRatio: false
		}
	});
}

async function editUser(id) {
	const user = allUsers.find(u => u.id === id);
	if (!user) return alert('User not found');

	const newName = prompt('Enter name:', user.name);
	if (newName === null) return;

	try {
		const res = await fetch(`/api/users/${id}`, {
			method: 'PUT',
			headers: {'Content-Type': 'application/json'},
			body: JSON.stringify({name: newName})
		});
		if (res.ok) {
			loadUsers();
			showNotification('User updated successfully', 'success');
		} else {
			showNotification('Failed to update user', 'error');
		}
	} catch (error) {
		console.error('Error updating user:', error);
		showNotification('Error updating user', 'error');
	}
}

async function deleteUser(id) {
	if (!confirm('Are you sure you want to delete this user?')) return;

	try {
		const res = await fetch(`/api/users/${id}`, {method: 'DELETE'});
		if (res.ok) {
			loadUsers();
			showNotification('User deleted successfully', 'success');
		} else {
			showNotification('Failed to delete user', 'error');
		}
	} catch (error) {
		console.error('Error deleting user:', error);
		showNotification('Error deleting user', 'error');
	}
}

function exportUsers() {
	const csv = 'Name,Email,Role,Status,Usage\n' + allUsers.map(u =>
		`${u.name},${u.email},${u.role},${u.status},${u.usage_current}/${u.usage_limit}`
	).join('\n');

	const blob = new Blob([csv], {type: 'text/csv'});
	const url = window.URL.createObjectURL(blob);
	const a = document.createElement('a');
	a.href = url;
	a.download = 'users.csv';
	a.click();
	showNotification('Users exported successfully', 'success');
}

function showNotification(message, type) {
	const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
	const alert = document.createElement('div');
	alert.className = `alert ${alertClass} alert-dismissible fade show`;
	alert.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
	document.body.insertBefore(alert, document.body.firstChild);
	setTimeout(() => alert.remove(), 3000);
}

document.addEventListener('DOMContentLoaded', () => {
	loadUsers();

	// Add user form
	const addForm = document.getElementById('addUserForm');
	addForm.addEventListener('submit', async (e) => {
		e.preventDefault();
		const body = Object.fromEntries(new FormData(addForm).entries());
		try {
			const res = await fetch('/api/users', {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify(body)
			});
			if (res.ok) {
				addForm.reset();
				bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
				loadUsers();
				showNotification('User added successfully', 'success');
			} else {
				showNotification('Failed to add user', 'error');
			}
		} catch (error) {
			console.error('Error adding user:', error);
			showNotification('Error adding user', 'error');
		}
	});

	// Search functionality
	document.getElementById('searchUsers').addEventListener('input', (e) => {
		const search = e.target.value.toLowerCase();
		const filtered = allUsers.filter(u =>
			u.name.toLowerCase().includes(search) ||
			u.email.toLowerCase().includes(search)
		);
		renderUsers(filtered);
	});
});
</script>
{% endblock %}