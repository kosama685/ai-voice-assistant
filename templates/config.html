{% extends 'base.html' %}

{% block page_title %}System Configuration{% endblock %}

{% block content %}
<div class="container-fluid">
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h3>System Configuration</h3>
		<button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addConfigModal">
			<i class="fas fa-plus"></i> Add Configuration
		</button>
	</div>

	<!-- Configuration Categories -->
	<div class="row mb-4">
		<div class="col-md-3">
			<div class="card text-center">
				<div class="card-body">
					<h5 class="card-title">LLM Settings</h5>
					<p class="text-muted">Language Model Configuration</p>
					<button class="btn btn-sm btn-outline-primary" onclick="filterConfigs('llm')">View</button>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="card text-center">
				<div class="card-body">
					<h5 class="card-title">ASR Settings</h5>
					<p class="text-muted">Speech Recognition</p>
					<button class="btn btn-sm btn-outline-primary" onclick="filterConfigs('asr')">View</button>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="card text-center">
				<div class="card-body">
					<h5 class="card-title">TTS Settings</h5>
					<p class="text-muted">Text-to-Speech</p>
					<button class="btn btn-sm btn-outline-primary" onclick="filterConfigs('tts')">View</button>
				</div>
			</div>
		</div>
		<div class="col-md-3">
			<div class="card text-center">
				<div class="card-body">
					<h5 class="card-title">All Settings</h5>
					<p class="text-muted">View All Configurations</p>
					<button class="btn btn-sm btn-outline-primary" onclick="filterConfigs('')">View</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Configuration Table -->
	<div class="card">
		<div class="card-header">
			<div class="d-flex justify-content-between align-items-center">
				<h5>Configuration Items</h5>
				<input type="text" class="form-control" id="searchConfig" placeholder="Search configurations..." style="width: 250px;">
			</div>
		</div>
		<div class="card-body">
			<div class="table-responsive">
				<table class="table">
					<thead>
						<tr>
							<th>Key</th>
							<th>Value</th>
							<th>Description</th>
							<th>Updated At</th>
							<th>Updated By</th>
							<th>Actions</th>
						</tr>
					</thead>
					<tbody id="configList">
						<tr>
							<td colspan="6" class="text-center text-muted">Loading configurations...</td>
						</tr>
					</tbody>
				</table>
			</div>
		</div>
	</div>
</div>

<!-- Add Config Modal -->
<div class="modal fade" id="addConfigModal" tabindex="-1">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">Add New Configuration</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
			</div>
			<form id="addConfigForm">
				<div class="modal-body">
					<div class="mb-3">
						<label for="newKey" class="form-label">Key</label>
						<input type="text" class="form-control" id="newKey" name="key" required>
					</div>
					<div class="mb-3">
						<label for="newValue" class="form-label">Value</label>
						<input type="text" class="form-control" id="newValue" name="value" required>
					</div>
					<div class="mb-3">
						<label for="newDescription" class="form-label">Description</label>
						<textarea class="form-control" id="newDescription" name="description" rows="3"></textarea>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
					<button type="submit" class="btn btn-primary">Add Configuration</button>
				</div>
			</form>
		</div>
	</div>
</div>

{% endblock %}

{% block scripts %}
<script>
let allConfigs = [];

async function loadConfigs() {
	try {
		const res = await fetch('/api/config');
		if (!res.ok) throw new Error('Failed to load configs');
		allConfigs = await res.json();
		renderConfigs(allConfigs);
	} catch (error) {
		console.error('Error loading configs:', error);
		document.getElementById('configList').innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading configurations</td></tr>';
	}
}

function renderConfigs(configs) {
	const tbody = document.getElementById('configList');
	if (configs.length === 0) {
		tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No configurations found</td></tr>';
		return;
	}

	tbody.innerHTML = configs.map(c => `
		<tr>
			<td><strong>${c.key}</strong></td>
			<td><code>${c.value}</code></td>
			<td>${c.description || '-'}</td>
			<td><small>${new Date(c.updated_at).toLocaleString()}</small></td>
			<td><small>User #${c.updated_by || '-'}</small></td>
			<td>
				<button class="btn btn-sm btn-outline-primary me-1" onclick="editConfig(${c.id})">
					<i class="fas fa-edit"></i>
				</button>
				<button class="btn btn-sm btn-outline-danger" onclick="deleteConfig(${c.id})">
					<i class="fas fa-trash"></i>
				</button>
			</td>
		</tr>
	`).join('');
}

function filterConfigs(filter) {
	if (!filter) {
		renderConfigs(allConfigs);
	} else {
		const filtered = allConfigs.filter(c => c.key.includes(filter));
		renderConfigs(filtered);
	}
}

async function editConfig(id) {
	const config = allConfigs.find(c => c.id === id);
	if (!config) return alert('Configuration not found');

	const newValue = prompt('Enter new value:', config.value);
	if (newValue === null) return;

	try {
		const res = await fetch(`/api/config/${id}`, {
			method: 'PUT',
			headers: {'Content-Type': 'application/json'},
			body: JSON.stringify({value: newValue})
		});
		if (res.ok) {
			loadConfigs();
			alert('Configuration updated successfully');
		} else {
			alert('Failed to update configuration');
		}
	} catch (error) {
		console.error('Error updating config:', error);
		alert('Error updating configuration');
	}
}

async function deleteConfig(id) {
	if (!confirm('Are you sure you want to delete this configuration?')) return;

	try {
		const res = await fetch(`/api/config/${id}`, {method: 'DELETE'});
		if (res.ok) {
			loadConfigs();
			alert('Configuration deleted successfully');
		} else {
			alert('Failed to delete configuration');
		}
	} catch (error) {
		console.error('Error deleting config:', error);
		alert('Error deleting configuration');
	}
}

document.addEventListener('DOMContentLoaded', () => {
	loadConfigs();

	// Add config form
	const addForm = document.getElementById('addConfigForm');
	addForm.addEventListener('submit', async (e) => {
		e.preventDefault();
		const body = Object.fromEntries(new FormData(addForm).entries());
		try {
			const res = await fetch('/api/config', {
				method: 'POST',
				headers: {'Content-Type': 'application/json'},
				body: JSON.stringify(body)
			});
			if (res.ok) {
				addForm.reset();
				bootstrap.Modal.getInstance(document.getElementById('addConfigModal')).hide();
				loadConfigs();
				alert('Configuration added successfully');
			} else {
				alert('Failed to add configuration');
			}
		} catch (error) {
			console.error('Error adding config:', error);
			alert('Error adding configuration');
		}
	});

	// Search functionality
	document.getElementById('searchConfig').addEventListener('input', (e) => {
		const search = e.target.value.toLowerCase();
		const filtered = allConfigs.filter(c =>
			c.key.toLowerCase().includes(search) ||
			c.value.toLowerCase().includes(search) ||
			(c.description && c.description.toLowerCase().includes(search))
		);
		renderConfigs(filtered);
	});
});
</script>
{% endblock %}
