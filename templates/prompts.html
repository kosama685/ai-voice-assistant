{% extends 'base.html' %}

{% block page_title %}Prompts Management{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2>üìù Prompts Management</h2>
      <p class="text-muted">Create, edit, and manage AI prompts</p>
    </div>
    <button class="btn btn-primary btn-lg" data-bs-toggle="modal" data-bs-target="#addPromptModal">
      <i class="bi bi-plus-circle"></i> Add New Prompt
    </button>
  </div>

  <!-- Alert Messages -->
  <div id="alertContainer"></div>

  <!-- Prompts Table -->
  <div class="card shadow-sm">
    <div class="card-header bg-light">
      <h5 class="mb-0">All Prompts</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover">
          <thead class="table-light">
            <tr>
              <th>ID</th>
              <th>Name</th>
              <th>Type</th>
              <th>Category</th>
              <th>Status</th>
              <th>Usage</th>
              <th>Rating</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="promptList">
          {% if prompts %}
            {% for p in prompts %}
            <tr>
              <td><span class="badge bg-secondary">{{ p.id }}</span></td>
              <td><strong>{{ p.name }}</strong></td>
              <td><span class="badge bg-info">{{ p.type }}</span></td>
              <td>{{ p.category }}</td>
              <td>
                {% if p.status == 'active' %}
                  <span class="badge bg-success">Active</span>
                {% elif p.status == 'inactive' %}
                  <span class="badge bg-danger">Inactive</span>
                {% else %}
                  <span class="badge bg-warning">Draft</span>
                {% endif %}
              </td>
              <td>{{ p.usage_count }}</td>
              <td>‚≠ê {{ p.rating }}</td>
              <td>
                <button class="btn btn-sm btn-outline-primary edit-prompt" data-id="{{ p.id }}" title="Edit">
                  <i class="bi bi-pencil"></i> Edit
                </button>
                <button class="btn btn-sm btn-outline-danger delete-prompt" data-id="{{ p.id }}" title="Delete">
                  <i class="bi bi-trash"></i> Delete
                </button>
              </td>
            </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="8" class="text-center text-muted py-4">
                No prompts found. <a href="#" data-bs-toggle="modal" data-bs-target="#addPromptModal">Create one now</a>
              </td>
            </tr>
          {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

{% include 'prompt_modals.html' %}
{% endblock %}

{% block scripts %}
<script>
// Utility function to show alerts
function showAlert(message, type = 'danger') {
  const alertDiv = document.createElement('div');
  alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
  alertDiv.innerHTML = `
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  document.getElementById('alertContainer').appendChild(alertDiv);
  setTimeout(() => alertDiv.remove(), 5000);
}

// Utility function to reload prompts
async function reloadPrompts() {
  try {
    const response = await fetch('/prompts');
    if (response.ok) {
      location.reload();
    }
  } catch (error) {
    console.error('Reload error:', error);
  }
}

document.addEventListener('DOMContentLoaded', () => {
  // Add Prompt Form
  const addForm = document.getElementById('addPromptForm');
  if (addForm) {
    addForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      try {
        const formData = new FormData(addForm);
        const body = {
          name: formData.get('name'),
          type: formData.get('type'),
          content: formData.get('content'),
          status: 'active'
        };

        const res = await fetch('/api/prompts', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (res.ok) {
          showAlert('‚úÖ Prompt created successfully!', 'success');
          addForm.reset();
          const modal = bootstrap.Modal.getInstance(document.getElementById('addPromptModal'));
          modal.hide();
          setTimeout(reloadPrompts, 1000);
        } else {
          const error = await res.json();
          showAlert(`‚ùå Error: ${error.error || 'Failed to create prompt'}`, 'danger');
        }
      } catch (error) {
        console.error('Create error:', error);
        showAlert(`‚ùå Error: ${error.message}`, 'danger');
      }
    });
  }

  // Edit Prompt Buttons
  document.querySelectorAll('.edit-prompt').forEach(btn => {
    btn.addEventListener('click', async () => {
      try {
        const id = btn.dataset.id;
        const res = await fetch(`/api/prompts/${id}`);

        if (!res.ok) {
          showAlert('‚ùå Prompt not found', 'danger');
          return;
        }

        const prompt = await res.json();
        const template = document.getElementById('editPromptModalTemplate');
        const clone = template.cloneNode(true);
        clone.id = `editPromptModal${id}`;
        clone.style.display = '';
        document.body.appendChild(clone);

        const modal = new bootstrap.Modal(clone);
        const form = clone.querySelector('.editPromptForm');

        // Populate form
        form.elements['id'].value = prompt.id;
        form.elements['name'].value = prompt.name;
        form.elements['type'].value = prompt.type;
        form.elements['content'].value = prompt.content;

        // Handle form submission
        form.addEventListener('submit', async (ev) => {
          ev.preventDefault();
          try {
            const formData = new FormData(form);
            const body = {
              name: formData.get('name'),
              type: formData.get('type'),
              content: formData.get('content')
            };

            const updateRes = await fetch(`/api/prompts/${id}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body)
            });

            if (updateRes.ok) {
              showAlert('‚úÖ Prompt updated successfully!', 'success');
              modal.hide();
              setTimeout(reloadPrompts, 1000);
            } else {
              const error = await updateRes.json();
              showAlert(`‚ùå Error: ${error.error || 'Failed to update prompt'}`, 'danger');
            }
          } catch (error) {
            console.error('Update error:', error);
            showAlert(`‚ùå Error: ${error.message}`, 'danger');
          }
        });

        modal.show();
      } catch (error) {
        console.error('Edit error:', error);
        showAlert(`‚ùå Error: ${error.message}`, 'danger');
      }
    });
  });

  // Delete Prompt Buttons
  document.querySelectorAll('.delete-prompt').forEach(btn => {
    btn.addEventListener('click', async () => {
      if (!confirm('Are you sure you want to delete this prompt?')) return;

      try {
        const id = btn.dataset.id;
        const res = await fetch(`/api/prompts/${id}`, { method: 'DELETE' });

        if (res.ok) {
          showAlert('‚úÖ Prompt deleted successfully!', 'success');
          setTimeout(reloadPrompts, 1000);
        } else {
          const error = await res.json();
          showAlert(`‚ùå Error: ${error.error || 'Failed to delete prompt'}`, 'danger');
        }
      } catch (error) {
        console.error('Delete error:', error);
        showAlert(`‚ùå Error: ${error.message}`, 'danger');
      }
    });
  });
});
</script>
{% endblock %}
