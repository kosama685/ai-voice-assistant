{% extends 'base.html' %}

{% block page_title %}Analytics{% endblock %}

{% block content %}
<div class="container">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3>Analytics</h3>
    <div>
      <label for="daysRange" class="form-label me-2">Range</label>
      <select id="daysRange" class="form-select d-inline-block" style="width:120px;">
        <option value="7">7d</option>
        <option value="30">30d</option>
        <option value="90">90d</option>
      </select>
    </div>
  </div>

  <div class="row">
    <div class="col-md-8">
      <div class="card mb-3">
        <div class="card-body">
          <canvas id="conversationsChart" height="120"></canvas>
        </div>
      </div>
      <div class="card">
        <div class="card-body">
          <h5>Function Usage</h5>
          <div id="functionUsageList"></div>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card mb-3">
        <div class="card-body">
          <h5>Summary</h5>
          <ul class="list-unstyled" id="summaryList"></ul>
        </div>
      </div>
      <div class="card">
        <div class="card-body">
          <h5>Recent Activities</h5>
          <div id="recentActivities"></div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let conversationsChart = null;
async function loadDashboard(days=7){
  const statsResp = await fetch('/api/dashboard/stats');
  if(!statsResp.ok) return;
  const stats = await statsResp.json();

  // summary
  const summary = [
    ['Total users', stats.total_users],
    ['Active users', stats.active_users],
    ['Total conversations', stats.total_conversations],
  ];
  const summaryList = document.getElementById('summaryList');
  summaryList.innerHTML = summary.map(s=>`<li><strong>${s[0]}:</strong> ${s[1]}</li>`).join('');

  // recent activities
  const ra = document.getElementById('recentActivities');
  ra.innerHTML = stats.recent_activities.map(a=>`<div class="mb-2"><small>${a.timestamp}</small><div>${a.action} ${a.resource} (#${a.resource_id})</div></div>`).join('');

  // function usage
  const fu = document.getElementById('functionUsageList');
  fu.innerHTML = Object.keys(stats.function_usage || {}).map(k=>`<div class="d-flex justify-content-between"><div>${k}</div><div>${stats.function_usage[k]}</div></div>`).join('');

  // load time series
  const daysParam = days;
  const usageResp = await fetch(`/api/analytics/usage?days=${daysParam}`);
  if(!usageResp.ok) return;
  const usage = await usageResp.json();
  const labels = usage.daily_counts.map(d=>d.date);
  const data = usage.daily_counts.map(d=>d.count);

  const ctx = document.getElementById('conversationsChart').getContext('2d');
  if(conversationsChart) conversationsChart.destroy();
  conversationsChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: [{ label: 'Conversations', data, fill:false, borderColor:'#007bff' }] },
    options: { responsive:true }
  });
}

document.addEventListener('DOMContentLoaded', ()=>{
  const sel = document.getElementById('daysRange');
  sel.addEventListener('change', ()=> loadDashboard(parseInt(sel.value)));
  loadDashboard(parseInt(sel.value));
});
</script>
{% endblock %}
