{% extends "base.html" %}

{% block title %}Prompt Management - Admin Panel{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-md-8">
            <h1 class="h3 mb-0">
                <i class="fas fa-comments"></i> Prompt Management
            </h1>
        </div>
        <div class="col-md-4 text-right">
            <button class="btn btn-primary" data-toggle="modal" data-target="#addPromptModal">
                <i class="fas fa-plus"></i> Create Prompt
            </button>
        </div>
    </div>

    <!-- Prompts Grid -->
    <div class="row" id="promptsGrid">
        <div class="col-md-12">
            <div class="text-center text-muted py-5">
                <i class="fas fa-spinner fa-spin fa-2x"></i>
                <p>Loading prompts...</p>
            </div>
        </div>
    </div>
</div>

<!-- Add Prompt Modal -->
<div class="modal fade" id="addPromptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create New Prompt</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="addPromptForm">
                    <div class="form-group">
                        <label>Prompt Name</label>
                        <input type="text" class="form-control" name="name" placeholder="e.g., Customer Support" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" name="description" rows="2" placeholder="Brief description of this prompt"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Prompt Content</label>
                        <textarea class="form-control" name="content" rows="6" placeholder="Enter the system prompt..." required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Personality</label>
                                <select class="form-control" name="personality">
                                    <option value="friendly">Friendly</option>
                                    <option value="professional">Professional</option>
                                    <option value="casual">Casual</option>
                                    <option value="formal">Formal</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Tone</label>
                                <select class="form-control" name="tone">
                                    <option value="conversational">Conversational</option>
                                    <option value="informative">Informative</option>
                                    <option value="supportive">Supportive</option>
                                    <option value="neutral">Neutral</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createPrompt()">Create Prompt</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Prompt Modal -->
<div class="modal fade" id="editPromptModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Prompt</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editPromptForm">
                    <input type="hidden" id="editPromptId">
                    <div class="form-group">
                        <label>Prompt Name</label>
                        <input type="text" class="form-control" id="editPromptName" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="form-control" id="editPromptDescription" rows="2"></textarea>
                    </div>
                    <div class="form-group">
                        <label>Prompt Content</label>
                        <textarea class="form-control" id="editPromptContent" rows="6" required></textarea>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Personality</label>
                                <select class="form-control" id="editPromptPersonality">
                                    <option value="friendly">Friendly</option>
                                    <option value="professional">Professional</option>
                                    <option value="casual">Casual</option>
                                    <option value="formal">Formal</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label>Tone</label>
                                <select class="form-control" id="editPromptTone">
                                    <option value="conversational">Conversational</option>
                                    <option value="informative">Informative</option>
                                    <option value="supportive">Supportive</option>
                                    <option value="neutral">Neutral</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="custom-control custom-checkbox">
                            <input type="checkbox" class="custom-control-input" id="editPromptActive">
                            <label class="custom-control-label" for="editPromptActive">
                                Active
                            </label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="updatePrompt()">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<style>
    .prompt-card {
        transition: transform 0.2s, box-shadow 0.2s;
        cursor: pointer;
    }
    .prompt-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    .prompt-card.active {
        border-left: 4px solid #28a745;
    }
    .prompt-content-preview {
        max-height: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        color: #666;
        font-size: 0.9rem;
    }
</style>

<script>
    async function loadPrompts() {
        try {
            const response = await fetch('/admin/api/prompts');
            const data = await response.json();
            
            if (data.success) {
                renderPrompts(data.prompts);
            }
        } catch (error) {
            console.error('Error loading prompts:', error);
            alert('Error loading prompts');
        }
    }

    function renderPrompts(prompts) {
        const grid = document.getElementById('promptsGrid');
        
        if (prompts.length === 0) {
            grid.innerHTML = `
                <div class="col-md-12">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-inbox fa-2x mb-3"></i>
                        <p>No prompts created yet</p>
                    </div>
                </div>
            `;
            return;
        }
        
        grid.innerHTML = prompts.map(prompt => `
            <div class="col-md-6 mb-4">
                <div class="card prompt-card ${prompt.is_active ? 'active' : ''}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h5 class="card-title mb-0">${prompt.name}</h5>
                            <span class="badge badge-${prompt.is_active ? 'success' : 'secondary'}">
                                ${prompt.is_active ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                        <p class="card-text text-muted small mb-2">${prompt.description || 'No description'}</p>
                        <div class="prompt-content-preview mb-3">
                            ${prompt.content}
                        </div>
                        <div class="mb-3">
                            <small class="text-muted">
                                <strong>Personality:</strong> ${prompt.personality} | 
                                <strong>Tone:</strong> ${prompt.tone}
                            </small>
                        </div>
                        <div class="btn-group btn-group-sm w-100" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="editPrompt(${prompt.id}, '${prompt.name}', '${prompt.description}', '${prompt.content}', '${prompt.personality}', '${prompt.tone}', ${prompt.is_active})">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="deletePrompt(${prompt.id})">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function editPrompt(id, name, description, content, personality, tone, isActive) {
        document.getElementById('editPromptId').value = id;
        document.getElementById('editPromptName').value = name;
        document.getElementById('editPromptDescription').value = description;
        document.getElementById('editPromptContent').value = content;
        document.getElementById('editPromptPersonality').value = personality;
        document.getElementById('editPromptTone').value = tone;
        document.getElementById('editPromptActive').checked = isActive;
        $('#editPromptModal').modal('show');
    }

    async function createPrompt() {
        const form = document.getElementById('addPromptForm');
        const formData = new FormData(form);
        const data = Object.fromEntries(formData);
        
        try {
            const response = await fetch('/admin/api/prompts', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            if (result.success) {
                $('#addPromptModal').modal('hide');
                form.reset();
                loadPrompts();
                alert('Prompt created successfully');
            }
        } catch (error) {
            console.error('Error creating prompt:', error);
            alert('Error creating prompt');
        }
    }

    async function updatePrompt() {
        const id = document.getElementById('editPromptId').value;
        const data = {
            name: document.getElementById('editPromptName').value,
            description: document.getElementById('editPromptDescription').value,
            content: document.getElementById('editPromptContent').value,
            personality: document.getElementById('editPromptPersonality').value,
            tone: document.getElementById('editPromptTone').value,
            is_active: document.getElementById('editPromptActive').checked
        };
        
        try {
            const response = await fetch(`/admin/api/prompts/${id}`, {
                method: 'PUT',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            
            const result = await response.json();
            if (result.success) {
                $('#editPromptModal').modal('hide');
                loadPrompts();
                alert('Prompt updated successfully');
            }
        } catch (error) {
            console.error('Error updating prompt:', error);
            alert('Error updating prompt');
        }
    }

    async function deletePrompt(id) {
        if (!confirm('Are you sure you want to delete this prompt?')) return;
        
        try {
            const response = await fetch(`/admin/api/prompts/${id}`, {method: 'DELETE'});
            const data = await response.json();
            if (data.success) {
                loadPrompts();
                alert('Prompt deleted successfully');
            }
        } catch (error) {
            console.error('Error deleting prompt:', error);
            alert('Error deleting prompt');
        }
    }

    // Load on page load
    document.addEventListener('DOMContentLoaded', loadPrompts);
</script>
{% endblock %}

